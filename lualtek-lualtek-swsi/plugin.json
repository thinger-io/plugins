{
  "name": "lualtek_lualtek_swsi",
  "version": "1.0.0",
  "description": "A simple actuator that can control 1 or 2 relays.",
  "author": "Thinger.io",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/thinger-io/plugins.git",
    "directory": "lualtek-lualtek-swsi"
  },
  "metadata": {
    "name": "Lualtek LUALTEK-SWSI",
    "description": "A simple actuator that can control 1 or 2 relays.",
    "image": "assets/lualtek-swsi.png",
    "category": "devices",
    "vendor": "lualtek"
  },
  "resources": {
    "products": [
      {
        "description": "A simple actuator that can control 1 or 2 relays.",
        "enabled": true,
        "name": "Lualtek LUALTEK-SWSI",
        "product": "lualtek_lualtek_swsi",
        "profile": {
          "buckets": {
            "lualtek_lualtek_swsi_data": {
              "backend": "mongodb",
              "data": {
                "payload": "{{payload}}",
                "payload_function": "decodeThingerUplink",
                "payload_type": "source_payload",
                "resource": "uplink",
                "source": "resource",
                "update": "events"
              },
              "enabled": true,
              "retention": {
                "period": 3,
                "unit": "months"
              },
              "tags": []
            }
          },
          "code": {
            "code": "function decodeThingerUplink(thingerData) {\n    // 0. If data has already been decoded, we will return it\n    if (thingerData.decodedPayload) return thingerData.decodedPayload;\n    \n    // 1. Extract and Validate Input\n    // We need 'payload' (hex string) and 'fPort' (integer)\n    const hexPayload = thingerData.payload || \"\";\n    const port = thingerData.fPort || 1;\n\n    // 2. Convert Hex String to Byte Array\n    const bytes = [];\n    for (let i = 0; i < hexPayload.length; i += 2) {\n        bytes.push(parseInt(hexPayload.substr(i, 2), 16));\n    }\n\n    // 3. Dynamic Function Detection and Execution\n    \n    // CASE A: (The Things Stack v3)\n    if (typeof decodeUplink === 'function') {\n        try {\n            const input = {\n                bytes: bytes,\n                fPort: port\n            };\n            var result = decodeUplink(input);\n            \n            if (result.data) return result.data;\n\n            return result; \n        } catch (e) {\n            console.error(\"Error inside decodeUplink:\", e);\n            throw e;\n        }\n    }\n\n    // CASE B: Legacy TTN (v2)\n    else if (typeof Decoder === 'function') {\n        try {\n            return Decoder(bytes, port);\n        } catch (e) {\n            console.error(\"Error inside Decoder:\", e);\n            throw e;\n        }\n    }\n\n    // CASE C: No decoder found\n    else {\n        throw new Error(\"No compatible TTN decoder function (decodeUplink or Decoder) found in scope.\");\n    }\n}\n\n\n// TTN decoder\nfunction getData(bytes) {\n    var switchValue = (bytes[0] << 8) | bytes[1];\n    var batteryValue = (bytes[2] << 8) | bytes[3];\n    var uplinkInterval = bytes.length > 4 ? (bytes[4] << 8) | bytes[5] : 0;\n  \n    var payload = {\n      switchValue: switchValue,\n      batteryValue: batteryValue\n    };\n  \n    if (uplinkInterval > 0) {\n      payload.uplinkInterval = uplinkInterval;\n    }\n  \n    return payload;\n  }\n  \n  function decodeUplink(input) {\n    switch (input.fPort) {\n      case 1:\n        return {\n          data: getData(input.bytes)\n        };\n      default:\n        return {\n          errors: ['unknown FPort'],\n        };\n    }\n  }\n  \n  function downlinkAction(data) {\n    if (data.switchValue === undefined && data.stepValue === undefined) {\n      return {\n        errors: ['Invalid data for downlink action'],\n      }\n    }\n  \n    return {\n      bytes: [parseInt(data.switchValue || data.stepValue, 10)],\n      fPort: 1\n    };\n  }\n  \n  function downlinkStepTiming(data) {\n    if (data.stepTiming === undefined) {\n      return {\n        errors: ['Invalid data for downlink step timing'],\n      }\n    }\n  \n    return {\n      bytes: [data.stepTiming],\n      fPort: 4\n    }\n  }\n  \n  var downlinkByPort = {\n    1: downlinkAction,\n    4: downlinkStepTiming\n  }\n  \n  function decodeDownlink(input) {\n    return {\n      data: {\n        bytes: input.bytes,\n        fPort: input.fPort\n      }\n    };\n  }",
            "environment": "javascript",
            "storage": "",
            "version": "1.0"
          },
          "properties": {
            "uplink": {
              "data": {
                "payload": "{{payload}}",
                "payload_function": "",
                "payload_type": "source_payload",
                "resource": "uplink",
                "source": "resource",
                "update": "events"
              },
              "default": {
                "source": "value"
              },
              "enabled": true
            }
          }
        },
        "_resources": {
          "properties": [
            {
              "property": "dashboard",
              "value": {
                "tabs": [
                  {
                    "name": "Main",
                    "widgets": [
                      {
                        "layout": {
                          "col": 0,
                          "row": 0,
                          "sizeX": 2,
                          "sizeY": 6
                        },
                        "panel": {
                          "color": "#2196F3",
                          "currentColor": "#2196F3",
                          "showOffline": {
                            "type": "none"
                          },
                          "title": "Switch State"
                        },
                        "properties": {
                          "color": "#4CAF50",
                          "max": 255,
                          "min": 0,
                          "unit": ""
                        },
                        "sources": [
                          {
                            "bucket": {
                              "backend": "mongodb",
                              "id": "lualtek_lualtek_swsi_data",
                              "mapping": "switchValue",
                              "tags": {
                                "device": [],
                                "group": []
                              }
                            },
                            "color": "#4CAF50",
                            "name": "Switch Value",
                            "source": "bucket",
                            "timespan": {
                              "mode": "latest"
                            }
                          }
                        ],
                        "type": "donutchart"
                      },
                      {
                        "layout": {
                          "col": 2,
                          "row": 0,
                          "sizeX": 2,
                          "sizeY": 6
                        },
                        "panel": {
                          "color": "#FF9800",
                          "currentColor": "#FF9800",
                          "showOffline": {
                            "type": "none"
                          },
                          "title": "Battery Level"
                        },
                        "properties": {
                          "color": "#FFC107",
                          "max": 4000,
                          "min": 2000,
                          "unit": "mV"
                        },
                        "sources": [
                          {
                            "bucket": {
                              "backend": "mongodb",
                              "id": "lualtek_lualtek_swsi_data",
                              "mapping": "batteryValue",
                              "tags": {
                                "device": [],
                                "group": []
                              }
                            },
                            "color": "#FFC107",
                            "name": "Battery",
                            "source": "bucket",
                            "timespan": {
                              "mode": "latest"
                            }
                          }
                        ],
                        "type": "donutchart"
                      },
                      {
                        "layout": {
                          "col": 0,
                          "row": 6,
                          "sizeX": 4,
                          "sizeY": 8
                        },
                        "panel": {
                          "color": "#ffffff",
                          "currentColor": "#ffffff",
                          "showOffline": {
                            "type": "none"
                          },
                          "title": "Switch State History"
                        },
                        "properties": {
                          "axis": true,
                          "fill": false,
                          "legend": true,
                          "multiple_axes": false
                        },
                        "sources": [
                          {
                            "bucket": {
                              "backend": "mongodb",
                              "id": "lualtek_lualtek_swsi_data",
                              "mapping": "switchValue",
                              "tags": {
                                "device": [],
                                "group": []
                              }
                            },
                            "color": "#4CAF50",
                            "name": "Switch State",
                            "source": "bucket",
                            "timespan": {
                              "magnitude": "hour",
                              "mode": "relative",
                              "period": "latest",
                              "value": 24
                            }
                          }
                        ],
                        "type": "chart"
                      },
                      {
                        "layout": {
                          "col": 4,
                          "row": 0,
                          "sizeX": 2,
                          "sizeY": 14
                        },
                        "panel": {
                          "color": "#ffffff",
                          "currentColor": "#ffffff",
                          "showOffline": {
                            "type": "none"
                          },
                          "title": "Recent Activity"
                        },
                        "properties": {
                          "source": "code",
                          "template": "<div style=\"width:100%; height:100%; overflow-y:auto\">\r\n  <table class=\"table table-striped table-condensed\">\r\n    <thead>\r\n      <tr>\r\n        <th>Date</th>\r\n        <th>Switch</th>\r\n        <th>Battery (mV)</th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      <tr ng-repeat=\"entry in value\">\r\n        <td>{{ entry.ts | date:'short' }}</td>\r\n        <td>{{ entry.switchValue }}</td>\r\n        <td>{{ entry.batteryValue }}</td>\r\n      </tr>\r\n    </tbody>\r\n  </table>\r\n</div>\r\n"
                        },
                        "sources": [
                          {
                            "aggregation": {},
                            "bucket": {
                              "backend": "mongodb",
                              "id": "lualtek_lualtek_swsi_data",
                              "mapping": "ts",
                              "tags": {
                                "device": [],
                                "group": []
                              }
                            },
                            "color": "#1abc9c",
                            "name": "ts",
                            "source": "bucket",
                            "timespan": {
                              "magnitude": "hour",
                              "mode": "relative",
                              "period": "latest",
                              "value": 24
                            }
                          },
                          {
                            "aggregation": {},
                            "bucket": {
                              "backend": "mongodb",
                              "id": "lualtek_lualtek_swsi_data",
                              "mapping": "switchValue",
                              "tags": {
                                "device": [],
                                "group": []
                              }
                            },
                            "color": "#4CAF50",
                            "name": "switchValue",
                            "source": "bucket",
                            "timespan": {
                              "magnitude": "hour",
                              "mode": "relative",
                              "period": "latest",
                              "value": 24
                            }
                          },
                          {
                            "aggregation": {},
                            "bucket": {
                              "backend": "mongodb",
                              "id": "lualtek_lualtek_swsi_data",
                              "mapping": "batteryValue",
                              "tags": {
                                "device": [],
                                "group": []
                              }
                            },
                            "color": "#FFC107",
                            "name": "batteryValue",
                            "source": "bucket",
                            "timespan": {
                              "magnitude": "hour",
                              "mode": "relative",
                              "period": "latest",
                              "value": 24
                            }
                          }
                        ],
                        "type": "html_time"
                      },
                      {
                        "layout": {
                          "col": 0,
                          "row": 14,
                          "sizeX": 4,
                          "sizeY": 6
                        },
                        "panel": {
                          "color": "#ffffff",
                          "currentColor": "#ffffff",
                          "showOffline": {
                            "type": "none"
                          },
                          "title": "Battery History"
                        },
                        "properties": {
                          "axis": true,
                          "fill": true,
                          "legend": true,
                          "multiple_axes": false
                        },
                        "sources": [
                          {
                            "bucket": {
                              "backend": "mongodb",
                              "id": "lualtek_lualtek_swsi_data",
                              "mapping": "batteryValue",
                              "tags": {
                                "device": [],
                                "group": []
                              }
                            },
                            "color": "#FFC107",
                            "name": "Battery (mV)",
                            "source": "bucket",
                            "timespan": {
                              "magnitude": "hour",
                              "mode": "relative",
                              "period": "latest",
                              "value": 24
                            }
                          }
                        ],
                        "type": "chart"
                      }
                    ]
                  }
                ]
              }
            }
          ]
        }
      }
    ]
  }
}